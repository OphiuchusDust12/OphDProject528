<apex:page standardController="Project__c" extensions="FeatureCreateFromProject" title="Create Feature" >
    
    <apex:stylesheet value="{!URLFOR($Resource.KendoUI, '/styles/kendo.common.min.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.KendoUI, '/styles/kendo.custom.css')}" />
    <apex:stylesheet value="{!$Resource.SupportConsoleCss}" />
    
    <apex:outputField value="{!Project__c.Summary__c}" rendered="false"/>
    <apex:outputField value="{!Project__c.ProblemStatement__c}" rendered="false"/>
    <apex:outputField value="{!Project__c.Feature__c}" rendered="false"/>
    
    <apex:form id="featureForm" >
        
        <apex:pageBlock mode="edit" id="featureBlock" title="Create Corporate TFS Feature">
            <div id="java-errors" style="display:none" class="warning-message"></div>
            <apex:messages styleClass="warning-message"/>
            <apex:pageblockSection columns="1">
                <apex:outputPanel layout="block"  rendered="{!HasFeature}" >
                    <div class="warning-message">Project <a href="/{!Project__c.Id}">{!Project__c.Name}</a> already is associated with Feature <a href="/{!Project__c.Feature__c}">{!Project__c.Feature__r.Name}</a></div>
                    <div><a class="k-button" href="#" onclick="cancel()">Cancel</a></div>
                </apex:outputPanel>
            </apex:pageblockSection>
            <apex:pageBlockSection id="featureSection" columns="1" rendered="{!NOT(HasFeature)}" >
                <apex:inputField required="true" id="title" style="width:80%;" value="{!feature.Title__c}"/>
                <apex:pageBlockSectionItem >
                    <apex:outputLabel for="details">Details</apex:outputLabel>
                    <textarea id="details" >{!feature.Details__c}</textarea>
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
            <apex:pageBlockButtons location="bottom"  rendered="{!NOT(HasFeature)}" >
                <div class="loading-div" style="display: none;" data-role="spinner-container">
                    <div id="topSpinner" data-role="spinner-element"></div><div data-role="spinner-text">Saving...</div><div class="clear-both"></div>
                </div>
                <div class="save-cancel-button-group">
                    <a id="create" class="k-button" href="#" onclick="createSfdcFeature()">Create Feature</a>
                    <a class="k-button" href="#" onclick="cancel()">Cancel</a>
                </div>
            </apex:pageBlockButtons>
        </apex:pageBlock>
        <apex:actionFunction action="{!Cancel}" name="cancel"/>
    </apex:form>
    
    <apex:includeScript value="{!URLFOR($Resource.KendoUI, '/js/jquery.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.KendoUI, '/js/kendo.web.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.KendoUI, '/js/kendo.core.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.JQuery, '/spin.js')}" />
    <apex:includeScript value="{!$Resource.incontactjs}" />
    <script type="text/javascript">
        
                $(document).ready(function() {
                    // create Editor from textarea HTML element with default set of tools
                    $("#details").kendoEditor();
                    
                    
        
                    $("#create").bind("click", function (e) {
                        $(".save-cancel-button-group").hide();
                        var spinnerOptions = {
                            top: -2,
                            left: 0,
                            lines: 9,
                            length: 4,
                            width: 3,
                            radius: 6,
                            corners: 1,
                            color: '#f48B31',
                            speed: 1.2,
                            trail: 40
                        };
            
                        var topSpinner = new Spinner(spinnerOptions);
                        topSpinner.spin(document.getElementById('topSpinner'));
                        var bottomSpinner = new Spinner(spinnerOptions);
                        bottomSpinner.spin(document.getElementById('bottomSpinner'));
                        $(".loading-div").show();
                    });
                });
                
        function createSfdcFeature(){
            var title = $(document.getElementById('{!$Component.featureForm.featureBlock.featureSection.title}')).val();
            var d = $("#details").data("kendoEditor").value();
            
            if(title == ''){
                document.getElementById("java-errors").innerHTML = 'Title is required';
                $("#java-errors").show();
            } else{
                FeatureCreateFromProject.InsertNewFeature(
                      title, d, '{!Project__c.Id}',
                      function(result,event)
                      {
                          
                          if (event.status) {
                              createTfsFeature(result);
                              $("#java-errors").hide();
                            } else if (event.type === 'exception') {
                                document.getElementById("java-errors").innerHTML = event.message;
                                $("#java-errors").show();
                            } else {
                                document.getElementById("java-errors").innerHTML = event.message;
                                $("#java-errors").show();
                            }
                      },
                      {escape: false}
               );
           }
        }
        
        function createTfsFeature(featureId){
            FeatureCreateFromProject.InsertTfsFeature(
                  featureId,
                  function(result,event)
                  {
                      
                      if (event.status) {
                          cancel();
                        } else if (event.type === 'exception') {
                            document.getElementById("java-errors").innerHTML = event.message;
                            $("#java-errors").show();
                        } else {
                            document.getElementById("java-errors").innerHTML = event.message;
                            $("#java-errors").show();
                        }
                  },
                  {escape: false}
           );
        }
    </script>
</apex:page>
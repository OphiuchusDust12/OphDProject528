<!--
 - Created by ravish.chawla on 10/12/2017.
 -->

<apex:page id="AssetSubscriptionAllocationNew" sideBar="false" controller="AssetSubscriptionAllocationNewController" title="Asset/Subscription Allocation" tabStyle="Project__c">

    <apex:includeScript value="{!URLFOR($Resource.inContactResource, '/inContactResource/js/jquery-3.1.1.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.KendoUIGanttChart, '/kendo-UI/js/kendo.all.min.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.inContactResource, '/inContactResource/js/bootstrap.min.js')}"/>


    <apex:stylesheet value="{!URLFOR($Resource.inContactResource, '/inContactResource/css/bootstrap.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.inContactResource, '/inContactResource/css/bootstrap-theme.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.KendoUIGanttChart, '/kendo-UI/styles/kendo.common.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.KendoUIGanttChart, '/kendo-UI/styles/kendo.default.mobile.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.KendoUIGanttChart, '/kendo-UI/styles/kendo.default.min.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.KendoUIGanttChart, '/kendo-UI/styles/kendo.silver.min.css')}"/>

    <apex:sectionHeader subtitle="{!Asset.Name}" title="Asset Allocation" rendered="{!NOT(ISNULL(Asset))}"/>

    <apex:sectionHeader subtitle="{!Subscription.Name}" title="Subscription Allocation" rendered="{!NOT(ISNULL(Subscription))}"/>

    <apex:sectionHeader subtitle="{!Project.Name}" title="Project Allocation" rendered="{!NOT(ISNULL(Project))}"/>


    <style>
        .image {
            padding-left:15px;
        }
       #detailTable .k-grid-header .k-header {
            background-color: #3f51b5 !important;
            border-color: #3343a4 !important;
            color : white !important;

        }
       #detailTable .k-grid-header .k-header>.k-link{
              color : white !important;
       }

        .spinnerClass {
            background:url('../../img/loading32.gif') no-repeat;
            height:32px;
            margin:20px;
            padding-left:40px;
            padding-top:9px;
            font-size: 0.75em;
    	}

    	.k-grid-Select{

     }

    </style>
    <apex:form id="myform">

        <apex:pageBlock title="Project Detail" rendered="{!Not(ISNULL(Project))}">
            <apex:pageBlockButtons title="" location="bottom">
                <apex:commandButton title="Back" value="Back" action="{!cancel}" immediate="true"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="2" >
                <apex:repeat value="{!$ObjectType.Project__c.FieldSets.PS_Project_Allocation}" var="f">
                    <apex:outputfield value="{!Project[f]}" />
                </apex:repeat>
            </apex:pageBlockSection>
        </apex:pageBlock>

        <apex:pageBlock title="Asset Detail" rendered="{!Not(ISNULL(asset))}">
            <apex:pageBlockButtons title="" location="bottom">
                <apex:commandButton title="Back" value="Back" action="{!cancel}" immediate="true"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="2" >
                <apex:repeat value="{!$ObjectType.Asset.FieldSets.PS_Asset_Allocation}" var="f">
                    <apex:outputfield value="{!Asset[f]}" />
                </apex:repeat>
            </apex:pageBlockSection>
        </apex:pageBlock>

        <apex:pageBlock title="Subscription Detail" rendered="{!Not(ISNULL(Subscription))}">
            <apex:pageBlockButtons title="" location="bottom">
                <apex:commandButton title="Back" value="Back" action="{!cancel}" immediate="true"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="2" >
                <apex:repeat value="{!$ObjectType.SubscriptionReplica__c.FieldSets.PS_Subscription_Allocation}" var="f">
                    <apex:outputfield value="{!Subscription[f]}" />
                </apex:repeat>
            </apex:pageBlockSection>
        </apex:pageBlock>

        <div id="assetAllocationPanel">
            <apex:pageBlock id="assetAllocationBlock">
                <apex:pageBlockSection collapsible="false"  columns="1" showHeader="true" title="Asset Allocation"/>
                <div id="assetAllocationList"></div>
            </apex:pageBlock>
        </div>
        <div id="subscriptiontAllocationPanel">
            <apex:pageBlock id="subscriptiontAllocationBlock">
                <apex:pageBlockSection collapsible="false"  columns="1" showHeader="true" title="Subscription Allocation"/>
                <div id="subscriptionAllocationList"></div>
                <div id="window"></div>
            </apex:pageBlock>
        </div>
        <!-- Confirmation Modal -->
        <div class="modal fade" id="warning" tabindex="-1" role="dialog" aria-labelledby="warning" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel" style="font-weight:bold">Alert</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" style="font-size:14px;">
                        <div id="java-errors" class=" alert alert-danger message-alert" style="margin-left:15px;width:90%; display:none;"></div>
                        <div id="success" class=" alert alert-success message-alert" style="margin-left:15px;width:90%; display:none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn button-cancel" data-dismiss="modal" style="color:black !important;">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- loading Modal -->
        <div class="modal fade" id="loading" tabindex="-1" role="dialog" aria-labelledby="info" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content" style="width:40%; top: 182px;">
                    <div class="modal-body" style="font-size:14px;">
                        <div class="spinnerClass">Adding Allocations</div>
                    </div>
                </div>
            </div>
        </div>

    </apex:form>
    <script type="text/x-kendo-template" id="windowTemplate">
        <p>Delete this Allocation for Asset <strong>#= AssetName #</strong> ? </p>
        <p>Allocated Quantity = <strong>#= AllocatedQuantity == null ? 0 : AllocatedQuantity #</strong></p>
        <p>Allocated Percentage = <strong>#= AllocatedPercentage == null ? 0 : AllocatedPercentage #</strong></p>
        <p>Allocated Hours = <strong>#= AllocatedHours #</strong> </p>
        <button class="k-button" id="yesButton">Yes</button>
        <button class="k-button" id="noButton"> No</button>
    </script>

    <script>


        $(document).ready(function() {
           getSObjType();

        });

        var assetQuantity = 0,
            currentObjectType;
        var windowTemplate = kendo.template($("#windowTemplate").html());

        function getSObjType(){
             AssetSubscriptionAllocationNewController.getObjectType(
                           '{!currentId}',
                            function(result, event){
                                    if(event.status){
                                        console.log('object type ==>' + result);
                                        if(result.length > 1){
                                            if(result == 'Asset'){
                                                currentObjectType = result;
                                              console.log('results =>' + JSON.stringify(result));
                                              $("#subscriptiontAllocationPanel").hide();
                                              assetAllocationData(null, '{!currentId}');
                                           }
                                           else if(result == 'Subscription'){
                                               currentObjectType = result;
                                               console.log('results =>' + JSON.stringify(result));
                                               $("#assetAllocationPanel").hide();
                                               subscriptionAllocationData(null, '{!currentId}');
                                           }else  if(result == 'Project'){
                                              currentObjectType = result;
                                              console.log('results =>' + JSON.stringify(result));
                                              subscriptionAllocationData('{!currentId}', null);
                                              assetAllocationData('{!currentId}', null);
                                           }
                                        }
                                    }
                             });
         }
        function assetAllocationData(projId, assetId){
               var assetAllocationData = new kendo.data.DataSource({
                    autosync:true,
                    transport:{
                      read: function(options){
                               AssetSubscriptionAllocationNewController.getAssetAllocationData(
                                   projId,
                                   assetId,
                                  function(result,event)
                                      {
                                          if (event.status) {
                                              if(result != null && result.length > 1){
                                                   options.success(JSON.parse(result));
                                                   console.log('results =>' + JSON.stringify(result));
                                              }else{
                                                  options.success('');
                                              }
                                          }
                                      },
                                      {escape: false}
                               );
                      },
                      update: function(options){
                          console.log('update options =>' + JSON.stringify(options.data));
                          AssetSubscriptionAllocationNewController.UpsertAssetSubscriptionAllocation(
                               'Asset',
                               JSON.stringify(options.data),
                                function(result,event){
                                      if (event.status) {
                                        var returnResult = JSON.parse(result);
                                        if(returnResult.result != 'Failed'){
                                           options.success();
                                           hideError();
                                        }else{
                                            displayError(returnResult.message);
                                        }
                                      }else{
                                        displayError(event.message);
                                      }
                                  },
                                  {escape: false}
                          );
                      },
                      create: function(options){
                            $('#loading').modal({
                                 backdrop: 'static',
                                 keyboard: false
                            });
                            $('#loading').modal('show');
                            console.log('options =>' + JSON.stringify(options.data));
                            if(options.data.ProjectNumber == null || options.data.ProjectNumber == '' || options.data.Asset == null || options.data.Asset == ''){
                                $('#loading').modal('hide');
                                 if(currentObjectType == 'Project')
                                        displayError('Please Select an Asset before save.');
                                 else if(currentObjectType == 'Asset')
                                         displayError('Please Select a Project before save.');
                            }else{
                                  AssetSubscriptionAllocationNewController.UpsertAssetSubscriptionAllocation(
                                           'Asset',
                                           JSON.stringify(options.data),
                                           function(result,event){
                                               if (event.status) {
                                                  var returnResult = JSON.parse(result);
                                                  if(returnResult.result != 'Failed'){
                                                       options.success();
                                                        $('#loading').modal('hide');
                                                        var grid = $("#assetAllocationList").data("kendoGrid");
                                                       grid.destroy();
                                                        getSObjType();
                                                       hideError();
                                                    }else{
                                                         $('#loading').modal('hide');
                                                    displayError(returnResult.message);
                                                  }
                                               }else{

                                                   $('#loading').modal('hide');
                                                   displayError(event.message);
                                               }
                                              },
                                              {escape: false}
                                      );
                                  }
                      }
                    },
                    schema:{
                        model: {
                            id: "AssetAllocationId",
                            fields: {
                                AssetAllocationId: { from: "AssetAllocationId"},
                                Asset: {from:"Asset", type: "string"},
                                AssetName : {from:"AssetName", type:"string"},
                                AssetAllocationName : {from:"AssetAllocationName", type:"string"},
                                ProjectNumber:{from:"ProjectNumber",type:"string"},
                                ProjectName:{from:"ProjectName",type:"string"},
                                ProjectPhase : {from:"ProjectPhase", type: "string"},
                                AllocatedQuantity:{from: "AllocatedQuantity", type:"number", nullable: true, editable:true},
                                AllocatedPercentage:{
                                    from: "AllocatedPercentage",
                                    type:"number",
                                    nullable: true,
                                    editable:true,
                                    validation : {
                                        percentageValidation : function(input){
                                            if(input.val() > 100 && input.is("[name='AllocatedPercentage']")){
                                                input.attr("data-percentageValidation-msg", " Invalid Percentage");
                                                return false;
                                            }
                                        return true;
                                        }
                                    }
                                },
                                AllocatedHours:{from: "AllocatedHours", type:"number",  nullable: true, editable:true},
                                Quantity :{from:"Quantity", type:"number"},
                                BudgtedHours :{from:"BudgtedHours", type:"number"}
                            }
                        }
                    },
                    change : calculateBudgetedHours
               });


        var window = $("#window").kendoWindow({
            title: "Are you sure you want to delete this record?",
            visible: false, //the window will not appear before its .open method is called
            width: "400px",
            height: "200px",
        }).data("kendoWindow");

              $("#assetAllocationList").kendoGrid({
                  dataSource: assetAllocationData,
                  editable: "inline",
                  scrollable: true,
                  noRecords: true,
                  height: 350,
                  edit: addDuplicateRowAsset,
                  dataBound : gridDataboundAsset,
                  detailInit: loadChildGrid,
                  cancel : hideChildProjects,

                  toolbar: [
                      {
                          name: "create",
                          text: "Add New Asset Allocation"

                      }
                      ],
                  columns: [{
                                field:"AssetAllocationId",
                                hidden: true,
                                editable:false

                            },
                            {
                                field:"AssetName",
                                title:"Asset",
                                editor:nonEditorAsset,
                                template: '#{ #<a href="/#: data.Asset #" target="_blank" name="AssetName">#= data.AssetName #</a># } #',
                            },
                            {
                                field:"AssetAllocationName",
                                title:"Allocation",
                                editor:nonEditorAsset,
                                template: '#{ #<a href="/#: data.AssetAllocationId #" target="_blank" >#= data.AssetAllocationName #</a># } #',
                            },
                            {
                                field:"ProjectName",
                                title:"Project",
                                editor:nonEditorAsset,
                                template: '#{ #<a href="/#: data.ProjectNumber #" target="_blank" >#= data.ProjectName #</a># } #',
                            },
                            {
                                field:"ProjectPhase",
                                title:"Project Phase",
                                editor:nonEditorAsset,
                                filterable:true
                            },
                            {
                                field:"AllocatedQuantity",
                                title:"Allocated Quantity",
                                editable:true
                            },
                            {
                                field:"AllocatedPercentage",
                                title:"Allocated Percentage",
                                editable:true
                            },
                            {
                                field:"AllocatedHours",
                                title:"Allocated Hours"
                            },
                            {   title:"Action",
                                command: ["edit",
                                {name: "Delete",
                                 click: function(e){  //add a click event listener on the delete button
                                         e.preventDefault(); //prevent page scroll reset
                                         var tr = $(e.target).closest("tr"); //get the row for deletion
                                         var data = this.dataItem(tr); //get the row data so it can be referred later
                                         window.content(windowTemplate(data)); //send the row data object to the template and render it
                                         window.center().open();
                                         $("#yesButton").click(function(){
                                               var grid = $("#assetAllocationList").data("kendoGrid");
                                               window.close();
                                               AssetSubscriptionAllocationNewController.DeleteAllocation(
                                                   data.AssetAllocationId,
                                                   'Asset',
                                                   function(result,event){
                                                       if (event.status) {
                                                          var returnResult = result;
                                                          if(result != 'Failed'){
                                                               grid.dataSource.remove(data);
                                                            }else{
                                                            displayError('Delete Unsuccessful.');
                                                          }
                                                       }else{
                                                           displayError(event.message);
                                                       }
                                                   },
                                                   {escape: false}
                                               );

                                         });
                                         $("#noButton").click(function(){
                                                window.close();
                                         });
                                 }
                                }]
                            }

                  ]
              });
       }


        function addDuplicateRowAsset(e){
            var assetGrid = $("#assetAllocationList").data("kendoGrid");
            var dataItems = assetGrid.dataItems();
            if(e.model.isNew() && !e.model.dirty ){
                if(currentObjectType == 'Asset'){
                    e.model.Asset = dataItems[0].get("Asset");
                    e.model.AssetName = dataItems[1].get("AssetName");
                    var firstCell = e.container.contents()[2];
                    $('<a href="/' +  e.model.Asset + '" target="_blank">' + e.model.AssetName +'</a>').appendTo(firstCell);
                    var projectCell = e.container.contents()[4];
                    $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">Select Projects </a>').appendTo(projectCell);
                    calculateRemainingAllocation(e.model, e.container);
                }else if(currentObjectType == 'Project'){
                    e.model.ProjectNumber = dataItems[1].get("ProjectNumber");
                    e.model.ProjectName = dataItems[1].get("ProjectName");
                    e.model.ProjectPhase = dataItems[1].get("ProjectPhase");
                    var projectCell = e.container.contents()[4];
                    $('<a href="/' +  e.model.ProjectNumber + '" target="_blank">' + e.model.ProjectName +'</a>').appendTo(projectCell);
                    var phaseCell = e.container.contents()[5];
                    $('<span>' +  e.model.ProjectPhase + '</span>').appendTo(phaseCell);

                    var firstCell = e.container.contents()[2];
                    $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">Select Assets </a>').appendTo(firstCell);
                }
                 var buttonCell = e.container.contents()[9];
                 $(buttonCell).find("a.k-primary").html('<span class="k-icon k-i-update"></span> Add');
            }else{
                enableAllocation(e.model, e.container);
            }



             $("#assetAllocationList").find(".k-hierarchy-cell, .k-hierarchy-col").hide();
        }

        function enableAllocation(rowData, row){
             var allocatedHoursCell =  $(row).children().eq(8);
            if(rowData.Quantity > 1){
                var allocatedQPercentageCell =  $(row).children().eq(7);
                $(allocatedQPercentageCell).find("span.k-numerictextbox").hide();
                $(allocatedHoursCell).find("input").prop('disabled', false).removeClass("k-state-disabled");
                $(allocatedHoursCell).find("span.k-select").show();
            }else if(rowData.Quantity == 1){
                var allocatedQuantityCell =  $(row).children().eq(6);
                $(allocatedQuantityCell).find("span.k-numerictextbox").hide();
                 $(allocatedHoursCell).find("input").prop('disabled', true).addClass("k-state-disabled");
                 $(allocatedHoursCell).find("span.k-select").hide();
            }

        }

        function calculateRemainingAllocation(rowData, row){
            var assetGrid = $("#assetAllocationList").data("kendoGrid");;
            var dataItems = assetGrid.dataItems();
                var totalQuantity = 0,
                    totalPercentage = 0;

                for(var i = 0; i < dataItems.length; i++){
                    if(dataItems[i].get("Asset") ==  rowData.Asset){
                        rowData.Quantity = dataItems[i].get("Quantity");
                        rowData.BudgtedHours = dataItems[i].get("BudgtedHours");
                    }
                    if(rowData.Quantity > 1 && dataItems[i].get("AllocatedQuantity") != null && dataItems[i].get("Asset") ==  rowData.Asset){
                         totalQuantity += Number(dataItems[i].get("AllocatedQuantity"));

                    }else if(rowData.Quantity == 1 && dataItems[i].get("AllocatedPercentage") != null && dataItems[i].get("Asset") ==  rowData.Asset){
                        totalPercentage += Number(dataItems[i].get("AllocatedPercentage"));
                    }
                }
                  var allocatedQuantityCell =  $(row).children().eq(6);
                  var allocatedQPercentageCell =  $(row).children().eq(7);
                  var allocatedHoursCell =  $(row).children().eq(8);
                  var hours;

                if(totalQuantity > 0){
                    var remainingQuantity = rowData.Quantity -  totalQuantity;
                    $(allocatedQPercentageCell).find("span.k-numerictextbox").hide();
                    rowData.AllocatedQuantity = remainingQuantity;
                    $(allocatedQuantityCell).find("span.k-numerictextbox").show();
                    $(allocatedQuantityCell).find("input").val(remainingQuantity);
                    hours = rowData.BudgtedHours * (remainingQuantity / rowData.Quantity);
                    $(allocatedHoursCell).find("input").prop('disabled', false).removeClass("k-state-disabled");
                    $(allocatedHoursCell).find("span.k-select").show();

                }else if(totalPercentage > 0 ){
                    var remainingPercentage = 100 -  totalPercentage;
                    rowData.AllocatedPercentage = remainingPercentage;
                    $(allocatedQuantityCell).find("span.k-numerictextbox").hide();
                    $(allocatedQPercentageCell).find("span.k-numerictextbox").show();
                    $(allocatedQPercentageCell).find("input").val(remainingPercentage);
                    var hours = rowData.BudgtedHours * (remainingPercentage / 100);
                    $(allocatedHoursCell).find("input").prop('disabled', true).addClass("k-state-disabled");
                    $(allocatedHoursCell).find("span.k-select").hide();

                }
                rowData.AllocatedHours = hours.toFixed(2);
                $(allocatedHoursCell).find("input").val(rowData.AllocatedHours)

        }


         function nonEditorAsset(container, options) {
             container.text(options.model[options.field]);
         }

       function gridDataboundAsset(e){
          // var grid = this;
          $("#assetAllocationList").find(".k-hierarchy-cell, .k-hierarchy-col").hide();


       }

       function calculateBudgetedHours(e){
            if (e.action === "itemchange" && (e.field == "AllocatedPercentage" || e.field == "AllocatedQuantity")){
                	var model = e.items[0],
                        budgtedHours = model.BudgtedHours,
                        currentValue;
                        allocatedHoursInput = $("#assetAllocationList").find("tr[data-uid='" + model.uid + "'] td:eq(8)");
                  if(model.AllocatedPercentage > 0 ){
                      currentValue = (budgtedHours * (model.AllocatedPercentage / 100)).toFixed(2);
                      $(allocatedHoursInput).find("input").val(currentValue).prop('disabled', true).addClass("k-state-disabled");
                       $(allocatedHoursInput).find("span.k-select").hide();
                  }else if(model.AllocatedQuantity > 0 ){
                      currentValue = (budgtedHours * (model.AllocatedQuantity / model.Quantity)).toFixed(2);
                      $(allocatedHoursInput).find("input").val(currentValue).prop('disabled', false).removeClass("k-state-disabled");
                      $(allocatedHoursInput).find("span.k-select").show();
                  }
                  model.AllocatedHours = currentValue;
            }
       }


       function loadDetail(obj){
           var row = $(obj).parent().parent();
           var link = $(row).find("td.k-hierarchy-cell .k-icon");

           link.click();
           $(row).find("tr.k-detail-row").show();
           $(row).next().find(".k-hierarchy-cell").hide();
       }

       function loadChildGrid(e){
           if(currentObjectType === 'Asset'){
               detailProjects(e);
           } else if(currentObjectType === 'Project'){
                detailAssets(e);
           }
       }

        function detailProjects(e) {
                 $("<div id='detailTable'/>").appendTo(e.detailCell).kendoGrid({
                            dataSource: {
                                autosync:true,
                                transport: {
                                    read: function(options){
                                         AssetSubscriptionAllocationNewController.PhaseProjectDetails(
                                            e.data.Asset,
                                            function(result,event){
                                              if (event.status) {
                                                  if(result.length > 1){
                                                       options.success(JSON.parse(result));
                                                       console.log('PhaseProjectDetails =>' + JSON.stringify(result));
                                                  }
                                              }
                                            },{escape: false}
                                         );
                                    },
                                },
                                schema:{
                                    model: {
                                        id: "ProjectId",
                                        fields: {
                                            ProjectId: { from: "Id"},
                                            ProjectNumber: {from:"Name", type: "string"},
                                            Summary : {from:"Summary__c", type:"string"},
                                            Status : {from:"ProjectStatus__c", type:"string"}
                                        }
                                    }
                                }
                            },
                            scrollable: false,
                            sortable: true,
                            columns: [
                                { command: { text: "Select", click : selectProject}, title: "Action", width: "60px" },
                                { field: "ProjectNumber", width: "110px" },
                                { field: "Summary", title:"Project Summary", width: "200px" },
                                { field: "Status", title:"Project Status", width: "110px" }
                            ]
                        });
                    }

          function selectProject(e){
              var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

              var detailGrid = this.wrapper;
              var parentRow = detailGrid.closest("tr.k-detail-row").prev("tr");
              var grid = $("#assetAllocationList").data("kendoGrid");
              var rowData = grid.dataItem(parentRow);
              if(rowData){
                  rowData.ProjectNumber = dataItem.ProjectId;
                  rowData.ProjectName = dataItem.ProjectNumber;
                  rowData.ProjectPhase = dataItem.ProjectNumber + ' - ' + dataItem.Summary;
                  //grid.dataSource.sync();

                  var projectCell = $(parentRow).children().eq(4);
                  var htmlContentProject = $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">' + dataItem.ProjectNumber +'</a>');
                  $(projectCell).html(htmlContentProject);
                  var projectPhaseCell = $(parentRow).children().eq(5);
                  var htmlProjectPhase = $('<span> ' + rowData.ProjectPhase +'</span>');
                  $(projectPhaseCell).html(htmlProjectPhase);
              }
              grid.collapseRow(parentRow);

          }

          function hideChildProjects(e){
              setTimeout(function(){
                   $("#assetAllocationList").find(".k-hierarchy-cell, .k-hierarchy-col").hide();
                   $("#subscriptionAllocationList").find(".k-hierarchy-cell, .k-hierarchy-col").hide();
              });
          }


         function detailAssets(e) {
                 $("<div id='detailTable'/>").appendTo(e.detailCell).kendoGrid({
                            dataSource: {
                                autosync:true,
                                transport: {
                                    read: function(options){
                                         AssetSubscriptionAllocationNewController.AssetSubscriptionDetailsFromProjectPhase(
                                            e.data.ProjectNumber,
                                            'Asset',
                                            function(result,event){
                                              if (event.status) {
                                                  if(result.length > 1){
                                                       options.success(JSON.parse(result));
                                                       console.log('Asset Details =>' + JSON.stringify(result));
                                                  }
                                              }
                                            },{escape: false}
                                         );
                                    },
                                },
                                schema:{
                                    model: {
                                        id: "AssetId",
                                        fields: {
                                            AssetId: { from: "Id"},
                                            AssetName: {from:"Name", type: "string"},
                                            RemainingPercentage : {from:"Remaning_Percentage__c", type:"string"},
                                            RemainingQuantity : {from:"RemainingQuantity__c", type:"string"},
                                            RemainingHours : {from:"Remaining_Hours__c", type:"string"}
                                        }
                                    }
                                }
                            },
                            scrollable: false,
                            sortable: true,
                            columns: [
                                 {command: { text: "Select", click : selectAsset}, title: "Action", width: "60px" },
                                { field: "AssetName", title:"Asset", width: "110px" },
                                { field: "RemainingPercentage", title:"Remaining Percentage", width: "200px" },
                                { field: "RemainingQuantity", title:"Remaining Quantity", width: "110px" },
                                { field: "RemainingHours", title:"Remaining Hours", width: "110px" }

                            ]
                        });
                    }

          function selectAsset(e){
              var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
              var detailGrid = this.wrapper;
              var parentRow = detailGrid.closest("tr.k-detail-row").prev("tr");
              var grid = $("#assetAllocationList").data("kendoGrid");
              var rowData = grid.dataItem(parentRow);
              if(rowData){
                  rowData.Asset = dataItem.AssetId;
                  rowData.AssetName = dataItem.AssetName;
                  rowData.AllocatedPercentage = null;
                  rowData.AllocatedQuantity = null;
                  rowData.AllocatedHours = 0;
                  var assetCell = $(parentRow).children().eq(2);
                  var htmlContentProject = $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">' + dataItem.AssetName +'</a>');
                  $(assetCell).html(htmlContentProject);
                  calculateRemainingAllocation(rowData, parentRow);
              }
              grid.collapseRow(parentRow);
          }


        function displayError(message){
             $("div#success").empty();
             $("div#success").hide();
             $("div#java-errors").css("display", "block");
             document.getElementById("java-errors").innerHTML =  message;
              $('#warning').modal('show');
             console.log('error =>' + message);
        }

         function hideError(){
             $("div#java-errors").css("display", "none");
             document.getElementById("java-errors").innerHTML = ' ';
            }


<!--subscriptions begin here -->

    function loadSubscriptionChildGrid(e){
        if(currentObjectType === 'Subscription'){
           detailSubscriptionProjects(e);
        } else if(currentObjectType === 'Project'){
            detailSubscription(e);
        }
    }


       function gridDataboundSubscription(e){
          // var grid = this;
          $("#subscriptionAllocationList").find(".k-hierarchy-cell, .k-hierarchy-col").hide();
      }


    function selectSubscription(e){
        var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
        var detailGrid = this.wrapper;
        var parentRow = detailGrid.closest("tr.k-detail-row").prev("tr");
        var grid = $("#subscriptionAllocationList").data("kendoGrid");
        var rowData = grid.dataItem(parentRow);
        if(rowData){
        rowData.Asset = dataItem.SubscriptionId;
        rowData.AssetName = dataItem.SubscriptionName;
        rowData.AllocatedPercentage = null;
        rowData.AllocatedQuantity = null;
        rowData.AllocatedHours = 0;
        var subscriptionCell = $(parentRow).children().eq(2);
        var htmlContentProject = $('<a style="color:blue;cursor:pointer;" onClick="loadSubscriptionDetail(this);">' + dataItem.SubscriptionName +'</a>');
        $(subscriptionCell).html(htmlContentProject);
        calculateRemainingSubscriptionAllocation(rowData, parentRow);
        }
        grid.collapseRow(parentRow);
    }

function calculateRemainingSubscriptionAllocation(rowData, row){
            var subscriptionGrid = $("#subscriptionAllocationList").data("kendoGrid");;
            var dataItems = subscriptionGrid.dataItems();
            var totalQuantity = 0,
            totalPercentage = 0;

            for(var i = 0; i < dataItems.length; i++){
                if(dataItems[i].get("Subscription") ==  rowData.Subscription){
                rowData.Quantity = dataItems[i].get("Quantity");
                rowData.BudgtedHours = dataItems[i].get("BudgtedHours");
                }
                if(rowData.Quantity > 1 && dataItems[i].get("AllocatedQuantity") != null && dataItems[i].get("Subscription") ==  rowData.Subscription){
                 totalQuantity += Number(dataItems[i].get("AllocatedQuantity"));

                }else if(rowData.Quantity == 1 && dataItems[i].get("AllocatedPercentage") != null && dataItems[i].get("Subscription") ==  rowData.Subscription){
                totalPercentage += Number(dataItems[i].get("AllocatedPercentage"));
                }
            }
            var allocatedQuantityCell =  $(row).children().eq(7);
            var allocatedQPercentageCell =  $(row).children().eq(8);
            var allocatedHoursCell =  $(row).children().eq(9);
            var hours;

            if(totalQuantity > 0){
                var remainingQuantity = rowData.Quantity -  totalQuantity;
                $(allocatedQPercentageCell).find("span.k-numerictextbox").hide();
                rowData.AllocatedQuantity = remainingQuantity;
                $(allocatedQuantityCell).find("span.k-numerictextbox").show();
                $(allocatedQuantityCell).find("input").val(remainingQuantity);
                hours = rowData.BudgtedHours * (remainingQuantity / rowData.Quantity);
                $(allocatedHoursCell).find("input").prop('disabled', false).removeClass("k-state-disabled");
                $(allocatedHoursCell).find("span.k-select").show();

            }else if(totalPercentage > 0 ){
                var remainingPercentage = 100 -  totalPercentage;
                rowData.AllocatedPercentage = remainingPercentage;
                $(allocatedQuantityCell).find("span.k-numerictextbox").hide();
                $(allocatedQPercentageCell).find("span.k-numerictextbox").show();
                $(allocatedQPercentageCell).find("input").val(remainingPercentage);
                var hours = rowData.BudgtedHours * (remainingPercentage / 100);
                $(allocatedHoursCell).find("input").prop('disabled', true).addClass("k-state-disabled");
                $(allocatedHoursCell).find("span.k-select").hide();

            }
            rowData.AllocatedHours = hours.toFixed(2);
            $(allocatedHoursCell).find("input").val(rowData.AllocatedHours)
        }


 function selectSubscriptionProject(e){
    var dataItem = this.dataItem($(e.currentTarget).closest("tr"));

    var detailGrid = this.wrapper;
    var parentRow = detailGrid.closest("tr.k-detail-row").prev("tr");
    var grid = $("#subscriptionAllocationList").data("kendoGrid");
    var rowData = grid.dataItem(parentRow);
    if(rowData){
      rowData.ProjectNumber = dataItem.ProjectId;
      rowData.ProjectName = dataItem.ProjectNumber;
      rowData.ProjectPhase = dataItem.ProjectNumber + ' - ' + dataItem.Summary;
      //grid.dataSource.sync();

      var projectCell = $(parentRow).children().eq(4);
      var htmlContentProject = $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">' + dataItem.ProjectNumber +'</a>');
      $(projectCell).html(htmlContentProject);
      var projectPhaseCell = $(parentRow).children().eq(6);
      var htmlProjectPhase = $('<span> ' + rowData.ProjectPhase +'</span>');
      $(projectPhaseCell).html(htmlProjectPhase);
    }
    grid.collapseRow(parentRow);

  }

    function detailSubscriptionProjects(e) {
        $("<div id='detailSubscriptionTable'/>").appendTo(e.detailCell).kendoGrid({
        dataSource: {
            autosync:true,
            transport: {
                read: function(options){
                     AssetSubscriptionAllocationNewController.PhaseProjectDetailsSubscription(
                        e.data.Subscription,
                        function(result,event){
                          if (event.status) {
                              if(result.length > 1){
                                   options.success(JSON.parse(result));
                                   console.log('PhaseProjectDetails =>' + JSON.stringify(result));
                              }
                          }
                        },{escape: false}
                     );
                },
            },
            schema:{
                model: {
                    id: "ProjectId",
                    fields: {
                        ProjectId: { from: "Id"},
                        ProjectNumber: {from:"Name", type: "string"},
                        Summary : {from:"Summary__c", type:"string"},
                        Status : {from:"ProjectStatus__c", type:"string"}
                    }
                }
            }
        },
        scrollable: false,
        sortable: true,
        columns: [
            { command: { text: "Select", click : selectSubscriptionProject}, title: "Action", width: "60px" },
            { field: "ProjectNumber", width: "110px" },
            { field: "Summary", title:"Project Summary", width: "200px" },
            { field: "Status", title:"Project Status", width: "110px" }
        ]
    });
    }

       function detailSubscription(e) {
            $("<div id='detailSubscriptionTable'/>").appendTo(e.detailCell).kendoGrid({
            dataSource: {
                autosync:true,
                transport: {
                    read: function(options){
                         AssetSubscriptionAllocationNewController.AssetSubscriptionDetailsFromProjectPhase(
                            e.data.ProjectNumber,
                            'Subscription',
                            function(result,event){
                              if (event.status) {
                                  if(result.length > 1){
                                       options.success(JSON.parse(result));
                                       console.log('Subscription Details =>' + JSON.stringify(result));
                                  }
                              }
                            },{escape: false}
                         );
                    },
                },
                schema:{
                    model: {
                        id: "SubscriptionId",
                        fields: {
                            SubscriptionId: { from: "Id"},
                            SubscriptionName: {from:"Name", type: "string"},
                            Product: {from:"Product__c", type: "string"},
                            RemainingPercentage : {from:"Remaning_Percentage__c", type:"string"},
                            RemainingQuantity : {from:"RemainingQuantity__c", type:"string"},
                            RemainingHours : {from:"Remaining_Hours__c", type:"string"}
                        }
                    }
                }
            },
            scrollable: false,
            sortable: true,
            columns: [
                 {command: { text: "Select", click : selectSubscription}, title: "Action", width: "60px" },
                { field: "SubscriptionName", title:"Subscription", width: "110px" },
                { field: "Product__c", title:"Product", width: "110px" },
                { field: "RemainingPercentage", title:"Remaining Percentage", width: "200px" },
                { field: "RemainingQuantity", title:"Remaining Quantity", width: "110px" },
                { field: "RemainingHours", title:"Remaining Hours", width: "110px" }
            ]
            });
        }

function calculateSubscriptionBudgetedHours(e){
    if (e.action === "itemchange" && (e.field == "AllocatedPercentage" || e.field == "AllocatedQuantity")){
            var model = e.items[0],
                budgtedHours = model.BudgtedHours,
                currentValue;
                allocatedHoursInput = $("#subscriptionAllocationList").find("tr[data-uid='" + model.uid + "'] td:eq(9)");
          if(model.AllocatedPercentage > 0 ){
              currentValue = (budgtedHours * (model.AllocatedPercentage / 100)).toFixed(2);
              $(allocatedHoursInput).find("input").val(currentValue).prop('disabled', true).addClass("k-state-disabled");
               $(allocatedHoursInput).find("span.k-select").hide();
          }else if(model.AllocatedQuantity > 0 ){
              currentValue = (budgtedHours * (model.AllocatedQuantity / model.Quantity)).toFixed(2);
              $(allocatedHoursInput).find("input").val(currentValue).prop('disabled', false).removeClass("k-state-disabled");
              $(allocatedHoursInput).find("span.k-select").show();
          }
          model.AllocatedHours = currentValue;
    }
}



 function loadSubscriptionDetail(obj){
       var row = $(obj).parent().parent();
       var link = $(row).find("td.k-hierarchy-cell .k-icon");

       link.click();
       $(row).find("tr.k-detail-row").show();
       $(row).next().find(".k-hierarchy-cell").hide();
   }

function subscriptionAllocationData(projId, subscriptionId){

   console.log('subscriptionId =>' + subscriptionId);
       var subscriptionAllocationData =new kendo.data.DataSource({
            autosync:true,
            transport:{
              read: function(options){
                       AssetSubscriptionAllocationNewController.getSubscriptionAllocationData(projId, subscriptionId,
                          function(result,event)
                              {
                                  if (event.status) {
                                      if(result.length > 1){
                                           options.success(JSON.parse(result));
                                      console.log('results =>' + JSON.stringify(result));
                                      }
                                  } else if (event.type === 'exception') {

                                  } else {

                                  }
                              },
                              {escape: false}
                       );
              },
              update: function(options){
                  options.success();
                },
                create: function(options){
                     options.success();
                },
                destroy: function(options){
                     options.success();
                }
            },
            schema:{
                model: {
                    id: "SubscriptionAllocationId",
                    fields: {
                        "Subscription": {from:"Subscription", type: "string", editable:false},
                        "SubscriptionAllocationId": { from: "SubscriptionAllocationId", type: "string",editable:false },
                        "SubscriptionName" : {from:"SubscriptionName", type:"string",editable:false },
                        "SubscriptionAllocationName" : {from:"SubscriptionAllocationName", type:"string",editable:false},
                        "Product": { from: "Product", type: "string",editable:false },
                        "ProductName": { from: "ProductName", type: "string",editable:false },
                        "ProjectNumber":{from:"ProjectNumber",type:"string",editable:false},
                        "ProjectName":{from:"ProjectName",type:"string", editable:false},
                        "ProjectPhase" : {from:"ProjectPhase", type: "string", editable:false},
                        "AllocatedQuantity":{from: "AllocatedQuantity", type:"number", editable: true, nullable: true},
                        "BudgtedHours":{from: "BudgtedHours", type:"number"},
                        "Quantity":{from: "Quantity", type:"number"},
                        "AllocatedHours":{from: "AllocatedHours", type:"number", editable: true, nullable: true},
                        "AllocatedPercentage":{from: "AllocatedPercentage", type:"number", editable: true, nullable: true}
                    }
                }
            },
            change : calculateSubscriptionBudgetedHours
       });



    $("#subscriptionAllocationList").kendoGrid({
          dataSource: subscriptionAllocationData,
          editable: "inline",
          scrollable: true,
          noRecords: true,
          edit:addDuplicateRowSubscription,
          height: 350,
          detailInit: loadSubscriptionChildGrid,
          dataBound: gridDataboundSubscription,
          cancel : hideChildProjects,
          toolbar: [
              {
                  name: "create",
                  text: "Add New Subscription Allocation"
              }
              ],
          columns: [{
                        field:"Id",
                        hidden: true,
                        editable:false

                    },
                    {
                        field:"SubscriptionName",
                        title:"Subscription",
                        editor:nonEditorSubscription,
                        template: '#{ #<a href="/#: data.Subscription #" target="_blank" >#= data.SubscriptionName #</a># } #',
                    },
                    {
                        field:"SubscriptionAllocationName",
                        title:"Subscription Allocation",
                        editor:nonEditorSubscription,
                        template: '#{ #<a href="/#: data.SubscriptionAllocationId #" target="_blank" >#= data.SubscriptionAllocationName #</a># } #',
                    },
                    {
                        field:"ProjectName",
                        title:"Project",
                        editor:nonEditorSubscription,
                        template: '#{ #<a href="/#: data.ProjectNumber #" target="_blank" >#= data.ProjectName #</a># } #',
                    },
                    {
                        field:"ProductName",
                        title:"Product",
                        editor:nonEditorSubscription,
                        template: '#{ #<a href="/#: data.Product #" target="_blank" >#= data.ProductName #</a># } #',
                    },
                    {
                        field:"ProjectPhase",
                        title:"Project Phase",
                        editor:nonEditorSubscription,
                        filterable:true
                    },
                    {
                        field:"AllocatedQuantity",
                        title:"Allocated Quantity",
                        editable:true
                    },
                    {
                        field:"AllocatedPercentage",
                        title:"Allocated Percentage",
                        editable:true
                    },
                    {
                        field:"AllocatedHours",
                        title:"Allocated Hours",
                        editable:true
                    },
                    {   title:"Action",
                        command: ["edit","destroy"]
                    }
                ]
            });
       }

        function nonEditorSubscription(container, options) {
        container.text(options.model[options.field]);
        }



         function addDuplicateRowSubscription(e){
            var subscriptionGrid = $("#subscriptionAllocationList").data("kendoGrid");;
            var dataItems = subscriptionGrid.dataItems();
            if(e.model.isNew() && !e.model.dirty ){
                if(currentObjectType == 'Subscription'){
                    e.model.Subscription = dataItems[1].get("Subscription");
                    e.model.SubscriptionName = dataItems[1].get("SubscriptionName");
                    var firstCell = e.container.contents()[2];
                    $('<a href="/' +  e.model.Subscription + '" target="_blank">' + e.model.SubscriptionName +'</a>').appendTo(firstCell);
                    var projectCell = e.container.contents()[4];
                    $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">Select Projects </a>').appendTo(projectCell);
                    calculateRemainingSubscriptionAllocation(e.model, e.container);
                }else if(currentObjectType == 'Project'){
                    e.model.ProjectNumber = dataItems[1].get("ProjectNumber");
                    e.model.ProjectName = dataItems[1].get("ProjectName");
                    e.model.ProjectPhase = dataItems[1].get("ProjectPhase");


                    var projectCell = e.container.contents()[4];
                    $('<a href="/' +  e.model.ProjectNumber + '" target="_blank">' + e.model.ProjectName +'</a>').appendTo(projectCell);
                    var phaseCell = e.container.contents()[6];
                    $('<span>' +  e.model.ProjectPhase + '</span>').appendTo(phaseCell);

                    var firstCell = e.container.contents()[2];
                    $('<a style="color:blue;cursor:pointer;" onClick="loadDetail(this);">Select Assets </a>').appendTo(firstCell);
                }
                 e.model.ProductName = dataItems[1].get("ProductName");
                 e.model.Product = dataItems[1].get("Product");
                 var ProductCell = e.container.contents()[5];
                 $('<a href="/' +  e.model.Product + '" target="_blank">' + e.model.ProductName +'</a>').appendTo(ProductCell);

                 var buttonCell = e.container.contents()[10];
                 $(buttonCell).find("a.k-primary").html('<span class="k-icon k-i-update"></span> Add');
            }else{
                enableSubscriptionAllocation(e.model, e.container);
            }
             $("#subscriptionAllocationList").find(".k-hierarchy-cell, .k-hierarchy-col").hide();
        }


        function enableSubscriptionAllocation(rowData, row){
            var allocatedHoursCell =  $(row).children().eq(9);
            if(rowData.Quantity > 1){
                var allocatedQPercentageCell =  $(row).children().eq(8);
                $(allocatedQPercentageCell).find("span.k-numerictextbox").hide();
                $(allocatedHoursCell).find("input").prop('disabled', false).removeClass("k-state-disabled");
                $(allocatedHoursCell).find("span.k-select").show();
            }else if(rowData.Quantity == 1){
                var allocatedQuantityCell =  $(row).children().eq(7);
                $(allocatedQuantityCell).find("span.k-numerictextbox").hide();
                 $(allocatedHoursCell).find("input").prop('disabled', true).addClass("k-state-disabled");
                 $(allocatedHoursCell).find("span.k-select").hide();
            }
        }

    </script>

</apex:page>
